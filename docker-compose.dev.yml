services:  
  # MongoDB Database Service  
  sim-mongodb:
    image: mongo:6.0  
    container_name: simargl-mongodb  
    restart: unless-stopped  
    ports:  
      - "27018:27017"  
    volumes:  
      - mongo_data:/data/db  
    networks:  
      - app-network

  # Redis Service for BullMQ  
  sim-redis:  
    image: redis:7.0-alpine  
    container_name: simargl-redis  
    restart: unless-stopped  
    ports:  
      - "6380:6379"  
    volumes:  
      - redis_data:/data  
    networks:  
      - app-network

  # NestJS API Service (Development with Hot Reload)
  sim-api:  
    build:  
      context: .  
      dockerfile: Dockerfile.dev
    container_name: simargl-api-dev  
    restart: unless-stopped  
    env_file:  
      - .env  
    ports:  
      - "${PORT:-3333}:3333"  
    depends_on:  
      - sim-mongodb  
      - sim-redis  
    volumes:
      # Mount source code for hot reload
      - ./apps:/usr/src/app/apps
      - ./libs:/usr/src/app/libs
      - ./nest-cli.json:/usr/src/app/nest-cli.json
      - ./tsconfig.json:/usr/src/app/tsconfig.json
      - ./tsconfig.build.json:/usr/src/app/tsconfig.build.json
      - ./package.json:/usr/src/app/package.json
      # Exclude node_modules to avoid conflicts
      - /usr/src/app/node_modules
      # Mount dist folder for compiled output
      - api_dist:/usr/src/app/dist
    networks:  
      - app-network
    environment:
      - NODE_ENV=development
      - MONGO_URI=mongodb://sim-mongodb:27017/simargl
      - REDIS_HOST=sim-redis
      - REDIS_PORT=6379
    # Docker Compose Watch (for newer versions)
    develop:
      watch:
        - action: sync
          path: ./apps
          target: /usr/src/app/apps
        - action: sync
          path: ./libs
          target: /usr/src/app/libs
        - action: rebuild
          path: ./package.json

volumes:  
  mongo_data:  
  redis_data:
  api_dist:

networks:  
  app-network:  
    driver: bridge 