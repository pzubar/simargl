---
alwaysApply: true
---

# Development Workflow Rules

## Getting Started

### Initial Setup
1. **Start Development Environment**:
   ```bash
   npm run docker:dev
   ```

2. **Initialize Database** (first time):
   ```bash
   docker-compose -f docker-compose.dev.yml exec sim-api npm run seed:dev
   ```

3. **View Logs**:
   ```bash
   npm run docker:dev:logs
   ```

### Daily Development Workflow

#### 1. Start Development Session
```bash
# Start all services
npm run docker:dev

# Optional: Start with watch mode for file changes
npm run docker:dev:watch
```

#### 2. Code Changes
- Modify code in `apps/` or `libs/` directories
- Hot reload automatically applies changes

#### 3. Testing Changes
```bash
# Run tests
docker-compose -f docker-compose.dev.yml exec sim-api npm test

# Run specific test file
docker-compose -f docker-compose.dev.yml exec sim-api npm test -- admin.controller.spec.ts

# Watch mode for testing
docker-compose -f docker-compose.dev.yml exec sim-api npm run test:watch
```

#### 4. Database Operations
```bash
# Access MongoDB shell
docker-compose -f docker-compose.dev.yml exec sim-mongodb mongosh simargl

# Reset database with fresh seed data
docker-compose -f docker-compose.dev.yml exec sim-api npm run seed:dev

# Update prompts
docker-compose -f docker-compose.dev.yml exec sim-api npm run update-prompt
```

#### 5. End Development Session
```bash
# Stop all services
npm run docker:dev:down
```

## Feature Development Process

### Adding New Admin UI Features

1. **Create Template First** (`.hbs` file):
   ```handlebars
   {{!-- apps/api/src/views/admin/new-feature.hbs --}}
   <div class="bg-white shadow rounded-lg">
     <!-- Use existing Tailwind patterns -->
   </div>
   ```

2. **Create Controller Method**:
   ```typescript
   @Get('new-feature')
   async newFeature(@Res() res: Response) {
     const html = this.templateService.renderLayout('main', 'admin/new-feature.hbs', {
       title: 'New Feature',
       currentPage: 'new-feature',
       showNavigation: true
     });
     res.send(html);
   }
   ```

3. **Add Service Logic** (if needed):
   ```typescript
   // Business logic goes in services, not controllers
   async getNewFeatureData() {
     return this.model.find().lean();
   }
   ```

4. **Test Implementation**:
   ```bash
   docker-compose -f docker-compose.dev.yml exec sim-api npm test -- new-feature.spec.ts
   ```

### Adding Background Jobs

1. **Create Processor**:
   ```typescript
   // apps/api/src/tasks/new-job.processor.ts
   @Processor('new-job-queue')
   export class NewJobProcessor {
     @Process('process-task')
     async processTask(job: Job) {
       // Implementation
     }
   }
   ```

2. **Register in Tasks Module**:
   ```typescript
   // apps/api/src/tasks/tasks.module.ts
   BullModule.registerQueue({
     name: 'new-job-queue',
   }),
   ```

3. **Schedule Jobs**:
   ```typescript
   // In service
   await this.newJobQueue.add('process-task', data, {
     repeat: { cron: '0 */6 * * *' } // Every 6 hours
   });
   ```

### Database Schema Changes

1. **Update Schema File**:
   ```typescript
   // apps/api/src/schemas/model.schema.ts
   @Schema({ timestamps: true })
   export class ModelName {
     @Prop({ required: true })
     newField: string;
   }
   ```

2. **Update Service Logic**:
   ```typescript
   // Handle new fields in service methods
   async createModel(data: CreateModelDto) {
     return this.modelModel.create(data);
   }
   ```

3. **Test Schema Changes**:
   ```bash
   docker-compose -f docker-compose.dev.yml exec sim-api npm run seed:dev
   ```

## Debugging Guidelines

### Common Issues & Solutions

#### 1. Container Not Starting
```bash
# Check logs
docker-compose -f docker-compose.dev.yml logs sim-api

# Rebuild containers
docker-compose -f docker-compose.dev.yml down
docker-compose -f docker-compose.dev.yml up --build
```

#### 2. Database Connection Issues
```bash
# Check if MongoDB is running
docker-compose -f docker-compose.dev.yml ps

# Restart MongoDB
docker-compose -f docker-compose.dev.yml restart sim-mongodb
```

#### 3. Template Rendering Issues
- Check template syntax in `.hbs` files
- Verify data structure passed to template
- Ensure template file path is correct

#### 4. CSS Not Updating
```bash
# Recompile Tailwind CSS
docker-compose -f docker-compose.dev.yml exec sim-api npx tailwindcss -i /usr/src/app/apps/api/src/public/input.css -o /usr/src/app/apps/api/src/public/output.css

# Copy from container if needed
npm run build:css:copy
```

### Logging and Monitoring

#### Application Logs
```bash
# Follow API logs
npm run docker:dev:logs

# View specific service logs
docker-compose -f docker-compose.dev.yml logs sim-mongodb
docker-compose -f docker-compose.dev.yml logs sim-redis
```

#### Queue Monitoring
- Access Bull Board UI at `http://localhost:3333/queues`
- Monitor job processing, failures, and retries

#### Database Inspection
```bash
# Access MongoDB shell
docker-compose -f docker-compose.dev.yml exec sim-mongodb mongosh simargl

# View collections
db.channels.find()
db.contents.find()
db.prompts.find()
```

## Best Practices Checklist

### Before Committing Code

✅ **Code Quality**
- [ ] All tests pass
- [ ] No ESLint errors
- [ ] TypeScript compilation successful
- [ ] Proper error handling implemented

✅ **UI/UX**
- [ ] Templates use existing Tailwind patterns
- [ ] No inline HTML in controllers
- [ ] Responsive design maintained
- [ ] Navigation properly highlighted

✅ **Architecture**
- [ ] Business logic in services, not controllers
- [ ] Proper dependency injection used
- [ ] Database operations use appropriate schemas
- [ ] Background jobs properly queued

✅ **Documentation**
- [ ] Complex logic commented
- [ ] Method signatures documented
- [ ] README updated if needed

### Performance Considerations
- Use `.lean()` for read-only MongoDB queries
- Implement pagination for large datasets
- Cache frequently accessed data in Redis
- Use background jobs for heavy processing
- Optimize database queries with proper indexes 